# 虚拟机字节码执行引擎

代码经过编译过后变为了字节码而不是直接编译为机器码，是编程语言的一大进步。Java所有的执行引擎都是一致的：输入的是字节码，处理过程是字节码解析的等效过程，输出的是结果。

## 运行时栈帧结构

![](http://www.theaze.cn/wp-content/uploads/2019/04/658141-20170702015031368-326038264.png)

**栈帧**是用于支持虚拟机运行方法调用和方法执行的数据结构，它是虚拟机运行时数据区中的**虚拟机栈**的栈元素，一个线程的方法调用链可能会很长，很多方法同时在运行，但对于字节码执行引擎来说，只有栈顶上的一个栈帧才是有效的，该栈帧被称为**当前栈帧**。

### 局部变量表

是一组变量值的存储空间，用于存放方法参数和方法内部定义的局部变量。在Class文件中，方法的Code属性的max_locals数据项确定了局部变量表的最大容量。局部变量表的容量以变量槽(Slot)为最小单位。

### 操作数栈

是一个后入先出的栈结构，操作数栈的每一个元素可以是任意的Java数据类型，当要执行字节码指令时(如iadd指令)，将会取出最接近栈顶的两个元素执行指令。

### 动态连接

每个栈帧都包含一个执行运行时常量池中该栈帧的方法的引用，持有这个引用是为了支持方法调用过程中的动态链接。Class文件中存在大量的符号引用，字节码中的方法调用指令就以常量池中指向的的符号引用作为参数。这些符号引用一部分在类加载阶段或在第一次使用的阶段就转化为直接引用，这种转换叫做**静态解析**，还有一部分在每一次运行期间转化为直接引用，这部分称为**动态连接**。

### 方法返回地址

方法的退出有两种方法：

- 遇到任何一个方法返回的字节码指令，这时候可能有返回值传递给上层方法调用者。
- 在方法执行时遇到了异常，只要在本方法的异常表中没有搜索到匹配的异常处理器，就会导致方法退出，此时不会给它的上层产生任何返回值。

当方法退出时，当前栈帧出栈，恢复上层方法的局部变量表和操作数栈，有返回值的话压入调用者栈帧的操作数栈中。