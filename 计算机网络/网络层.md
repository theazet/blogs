# 网络层

#### IP(Internet Protocol) 网际协议

IP协议可以将多个包交换网络连接起来，在源地址与目的地址之间传输数据报，它也提供数据报重新组装的功能，以适应不同网络对包大小的要求

与IP协议配套使用的协议：

- 地址解析协议ARP：用于实现IP地址到MAC的对应
- 网际控制报文协议ICMP：用于差错控制和状态询问
- 网际组管理协议IGMP：用于实现网络中主机的实时加入和退出
- 逆地址解析协议RARP(已淘汰)

#### ARP(Address Resolution Protocol) 地址解析协议

**解决的问题：**

在以太网协议中，一台主机与另外一台主机通信，必须知道对方的MAC地址，但是TCP/IP协议中，运输层和网络层只关注对方的IP地址，在数据链路层接到上层提供的数据中，只能知道对方的IP地址，所以需要一种协议实现IP地址到MAC地址的转换。

每一台主机中都设有一个ARP高速缓存，动态储存一个已知的P地址与物理地址(MAC)的映射表。在主机A向另一台主机B发送IP数据报时会查询映射表，如果存在该对应该IP的记录，就可以直接取出对应的MAC地址写入MAC帧。如果没有找到就会触发ARP。

**ARP的过程：**

1. 向所在的局域网广播一个ARP请求分组，分组的主要内容是自己的IP地址，自己的MAC地址，主机B的IP地址
2. 本局域网所有ARP进程都会接受此ARP请求分组。
3. 如果主机B在局域网上，主机B在判断ARP请求中的IP与自己的IP一致后就会收下这个请求分组，并单播回送ARP响应分组，分组中包含着自己的IP与MAC地址；其他主机由于判断其与自己的IP不一致，则会丢弃这个请求分组。
4. 主机A接收到ARP响应分组后在ARP高速缓存中写入主机B的IP与MAC地址的映射。

#### ICMP(Internet Control Message Protocol) 网际控制报文协议

ICMP是装在IP数据报中的数据。

ICMP分为两种

1. ICMP差错报告报文
2. ICMP询问报文

**ICMP差错报告报文的类型：**

1. 终点不可达：路由器或主机不能交付数据报时向源点回送
2. 时间超过：路由器收到时间为0的数据报时向源点回送
3. 参数问题：路由器或目的主机收到数据报的首部有不正确的字段时向源点回送
4. 改变路由：路由器将改变路由改变报文发送给主机，让主机知道下次应将数据报发送给另外的路由

**ICMP差错报告报文结构：**

ICMP前8个字节(前四个字节固定，后四个字节代表ICMP类型)+出现差错的IP数据报首部+数据字段前8个字节

**ICMP询问报文的类型：**

1. 回送请求和回答：ICMP回送请求报文是主机或路由器向特定目的主机发出的询问，目的主机收到后必须发送ICMP回答报文，可以测试目的站是否可达以及了解相关网络状态，如PING命令。
2. 时间戳请求和回答：ICMP时间戳请求报文是请某台目的主机回答当前的日期与时间。

### 内部网关协议RIP(路由信息协议)

RIP要求每一个路由器都要维护自己到其他每一个目的网络的距离纪录。

RIP使用的是UDP协议。

RIP将“距离”定义为，一个主机到达目的主机所经过的路由器数，又称为“跳数”，最小为1(直连)，最大为15,16代表不可达，所以RIP只能适用于小型互联网。

特点：

1. 仅与相邻的路由器交换信息
2. 路由器交换的信息是当前本路由器知道的全部信息，即当前的路由表
3. 按固定时间间隔交换路由信息

RIP让一个自制系统中所有路由器都与相邻的路由器交换路由信息，不断更新路由表，使得每一个路由器到每一个目的网络的路由都是最短的。

优点：实现简单，开销小

缺点：1.当一个主机由可达变为不可达时(如出现故障)，其他主机要经过较长时间才能得知这个信息。2.最大仅支持15跳，难以实现大规模网络。

### 内部网关协议OSPF(开放最短路径优先)

OSPF将“距离”定义为“度量”，用与表示费用、距离、带宽、时延等。

OSPF不使用UDP而是直接用IP数据报发送

特点：

1. 通过洪泛法向本自治区域内所有的路由器发送信息
2. 发送的信息是本自治区域内与本路由器相邻的所有路由器的链路状态
3. 只有链路发生变化时才向所有路由器洪泛，不需要想RIP一样定期发送

各个路由器频繁交换，所有路由器都会建立一个链路状态数据库，这其实就是一个全网一致的全自治区域网络拓补图。

优点：更新过程收敛快。

为了能让OSPF协议能够适用于更大规模的网络，它将一个大的自治区域分成几个小的自治区域，每个小的自治区域要有一个自治系统边界路由器，专门与本自制系统以外的其他自制系统交换路由信息。这样可以减少整个自治区域的通信量。

### 外部网关协议BGP(边界网关协议)

特点：

1. 每一个自治区域都要有至少一个“发言人”
2. “发言人”和其他自治区域通过TCP连接交换路由信息
3. 自治区域内使用内部网关协议

### IGMP(网际组管理协议)

用来在IP主机和与其直接相邻的组播路由器之间建立、维护组播组成员关系。 