# 运输层

## UDP(User Datagram Protocol 用户数据报协议)

### UDP概述

语音和视频一般会使用UDP传输，实时视频和音频流应用程序旨在处理偶尔丢失、错误的数据报，因此只会发生偶尔的质量轻微下降，而避免了重传数据报带来的高延迟。

在一些关键的互联网协议中也使用了UDP协议，包括**DNS、DHCP、SNMP、RIP**

### UDP特点

1. UDP是无连接的
2. UDP只是尽最大努力交付，不保证可靠交互
3. UDP是面向报文的，不拆分也不合并
4. UDP没有拥塞控制，网络中的拥塞不会使源主机的发送速率降低
5. UDP支持一对一、多对一、一对多、多对多的交互通信
6. UDP首部开销小

## TCP协议

### TCP概述

TCP提供**面向连接**的服务。在传送数据之前必须先建立一个连接，数据传输结束后要释放连接。TCP不提供广播或多播的服务。由于TCP要提供可靠的、面向连接的服务，因此不可避免的增加了许多的开销，如确认、流量控制、计时器、连接管理等，不仅占用了首部资源，还要占用许多处理机资源。

### TCP特点

1. TCP是面向连接的运输层协议
2. 每一条TCP连接只能有两个端点
3. TCP提供可靠交付的服务
4. TCP提供全双工通信
5. 面向字节流

### TCP可靠的工作原理

#### 停止等待协议

**1.无差错情况**

“停止等待”就是每发送完一个分组就停止发送，等待接收方的接收确认，收到确认后再发送下一个分组。

**2.出现差错**

发送方为每一个已发送分组都设置了一个**超时计时器**，如果在超时计时器到期之前收到了确认，就会撤销计时器，但如果丢失了某个分组，那么发送方就会在超时计时器时间内收不到接收确认，这时发送方就会确认分组已丢失，那么就会重传该丢失的分组，这就是**超时重传**。

**3.确认丢失和确认迟到**

发送方并不知道自己发出的分组是否是丢失、迟到，还是接收方的确认分组丢失、迟到，只是当计时器到期后就会重传，所以应有相应的处理。如果接收方收到了重复的分组，会丢弃这个分组，不向上层交付，并再次回送确认。发送方如果收到了重复的确认，也会丢弃这个分组

**4.信道利用率**

停止等待协议优点是简单，但是信道利用率太低，为了提高利用率，一般采用流水线传输，如**连续ARQ协议**和**滑动窗口协议**。

#### 连续ARQ协议

发送方维持一个**发送窗口**，发送时不用挨个等待确认，可以把发送窗口的分组都发送出去，发送方每收到一个确认，就把发送窗口向前滑动一个分组。

接收方一般采用累积确认的方式，接收方不必对分组逐个确认，只需要对按序到达的最后一个分组发送确认，这就表示到这个分组为止的所有分组都已经收到了。

缺点：如果一组分组中的某一个分组发生了丢失，那这个分组之后的所有分组都必须重传， 所以在质量不佳的线路上，使用ARQ协议反而会带来负面影响。

#### 以字节为单位的滑动窗口

TCP采用大小可变的滑动窗口进行流量控制，滑动大小是字节。发送窗口是连接建立时双方商定的，但是在通信的过程中，接收端可以根据自己的资源情况随时调整对方发送窗口的上限值，

**发送方缓存暂时存放：**

1. 发送方应用程序传送给发送方TCP准备发送的数据
2. TCP已发送但尚未收到确认的数据

**接收方缓存暂时存放**

1. 按序到达的、但尚未被接收应用程序读取的数据
2. 未按序到达的数据

**特点：**

1. 发送方的发送窗口虽然是根据接收方的接收窗口设置的，但同一时刻它们并不一定相等。
2. 对于不按序到达的数据如何处理，TCP标准没有明确规定。
3. TCP要求接收方必须有累计确认的功能。

### TCP流量控制

流量控制就是让发送方发送速率不要太快，要让接收方来得及接收。发送窗口不能超过接收窗口给出的接收窗口的数值

### TCP拥塞控制

计算机网络中的链路容量(带宽)、交换节点中的缓存和处理机等都是网络资源，如果对其中的某一项资源的需求超出了该网络所能提供的可用部分，网络性能就会变坏，这种情况叫做**拥塞**。

**拥塞控制**就是防止过多的数据注入到网络中，这样可以使网络中的路由器或链路不致过载。

从控制理论来看拥塞控制理论，可以分为**开环控制**和**闭环控制**两个方法。

开环控制：在设计网络是事先将有关发生拥塞的因素考虑到，力求在运行中不产生拥塞，但网络运行起来就不再改正。

闭环控制：

1. 检测网络系统以检测拥塞在何时何处发生。
2. 将拥塞产生的信息传送到可采取行动的地方
3. 调整网络系统的运行以解决情况

#### TCP拥塞控制方法

有四种方法：慢开始、拥塞避免、快重传、快恢复

**慢开始和拥塞避免**

![](http://www.theaze.cn/wp-content/uploads/2019/05/批注-2019-05-06-152902.png)

发送方维持一个拥塞窗口，拥塞窗口的大小取决于网络的拥塞程度，并且在动态变化。发送方让自己的发送窗口等于拥塞窗口。慢开始就是由小到大逐渐增大拥塞窗口，也就是发送窗口。

**慢开始算法**规定，如果没有发生拥塞，每经过一个传输轮次，拥塞窗口就会加倍，直到达到一个**慢开始门限**。

**拥塞避免算法**规定，如果没有发生阻塞，每经过一个传输轮次，拥塞窗口就会加1。如果发生了拥塞就重新调整门限值为发生拥塞时窗口的一半，再重新执行慢开始算法。

**快重传与快恢复**

![](http://www.theaze.cn/wp-content/uploads/2019/05/批注-2019-05-06-153117.png)

**快重传算法**规定，当发送方连续收到三个重复确认时，就知道接收方丢失了某个($M_3$)分组，会立即重传该分组，就不会误认为发生了拥塞。

![](http://www.theaze.cn/wp-content/uploads/2019/05/1206020-20180606220922811-277591111.png)

由于发送方知道只是丢失了个别的报文段，于是不从慢开始算法开始，而是调整门限值以后直接执行拥塞避免算法。

### TCP的运输连接管理

**TCP连接的三次握手和四次挥手**

![](http://www.theaze.cn/wp-content/uploads/2019/05/181351206012825-e1557192860371.png)

1. 客户端发送SYN(synchronous建立联机)请求，进入SYN-SENT(在发送连接请求后等待匹配的连接请求)状态
2. 服务器端发送SYN请求，以及发送SYN的ACK(acknowledgement 确认)，进入SYN-RECEIVED(在收到和发送一个连接请求等待对连接请求的确认)状态
3. 客户端发送对SYN的ACK，进入ESTABLISHED(连接已建立)状态，服务器收到该请求，也进入ESTABLISHED状态
4. 客户端想要主动关闭连接，发送一个FIN(finish结束)请求，进入FIN_WAIT_1(等待中断)阶段。
5. 服务器端回送一个ACK，进入CLOSE_WAIT(等待关闭)阶段，此时服务器端可以将最后需要发送的数据发送完毕，客户端收到确认后进入FIN_WAIT_2(等待中断)阶段。
6. 服务器发送一个FIN请求，表示自己已经准备好关闭连接，已经没有什么需要发送的了，进入LAST_ACK(最终确认)阶段。
7. 客户端返回一个ACK确认自己已经收到了关闭连接的请求，进入TIME_WAIT(等待)阶段，但并不直接关闭，而是等待一段时间(2个MSL时间)，这是为了避免这个ACK在传送中丢失，而导致服务器端不断传送FIN请求。
8. 服务器端收到ACK后CLOSE(关闭连接)

